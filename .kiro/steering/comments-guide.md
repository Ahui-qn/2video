# 中文注释指南

本项目已为核心文件添加了面向初学者的中文注释。

## 注释原则

1. **只在关键位置添加注释**：函数入口、核心逻辑、复杂判断、重要数据流
2. **解释"为什么"而不是"是什么"**：注释应该解释设计决策和背后的原因
3. **通俗易懂**：使用简单的语言，避免过于技术化的术语
4. **不逐行注释**：代码本身应该是自解释的

## 已添加注释的文件

### 核心应用文件
- `App.tsx` - 应用主入口，视图路由管理
- `types.ts` - 全局类型定义，理解数据结构的关键

### 协作相关
- `components/CollaborationContext.tsx` - 实时协作核心，WebSocket管理
- `components/Workspace.tsx` - 工作区主组件，协调所有功能

### 服务端
- `server/index.js` - 后端服务器入口

### AI服务
- `services/geminiService.ts` - AI剧本分析服务（部分）

### 测试
- `tests/collaboration.test.ts` - 协作功能测试

## 关键概念说明

### 两阶段AI分析
1. **阶段1：提取全局资产** (`extractAssetsOnly`)
   - 分析完整剧本
   - 建立角色和场景的"资产库"
   - 确保描述一致性

2. **阶段2：生成分镜** (`analyzeScript`)
   - 分析单集剧本
   - 引用全局资产库
   - 生成详细的镜头列表

### 防止同步循环
实时协作中最容易出现的bug：
```
用户A修改 -> 广播给B -> B收到更新 -> B的状态变化 -> B又广播给A -> 无限循环
```

解决方案：
- 使用 `isRemoteUpdate` 标记区分本地更新和远程更新
- 只有本地更新才广播，远程更新不再广播
- 使用ref避免竞态条件

### 防抖机制
用户快速编辑时，不立即广播每次修改，而是等待1秒后再发送。
这样可以：
- 减少网络请求
- 降低服务器压力
- 提升用户体验

## 继续学习

如果你想深入了解某个功能，建议按以下顺序阅读：

1. **理解数据结构**：先看 `types.ts`
2. **理解应用流程**：看 `App.tsx` 的视图切换
3. **理解协作机制**：看 `CollaborationContext.tsx`
4. **理解核心功能**：看 `Workspace.tsx` 的状态管理
5. **理解AI分析**：看 `geminiService.ts` 的两阶段流程
