# 最近更新 (Recent Changes)

## 最新修复 (Latest Fixes)

### 查看者分镜表权限修复 ✅
**问题**：查看者无法滚动分镜表页面，也无法展开/收起集数

**修复**：
- 移除了分镜表容器的`pointer-events-none`样式
- 查看者现在可以正常滚动和展开/收起
- 编辑功能通过props控制（传入undefined禁用）

**文件**：`components/Workspace.tsx`

### 全局资产库UI美化 ✅
**改进**：
- 调整为与分镜表相同的滚动布局
- 统一卡片大小（固定高度280px）
- 添加酸性设计风格：
  - 渐变标题栏
  - 发光圆点指示器
  - 悬停发光效果
  - 圆角边框
- 响应式网格布局（1-4列自适应）
- 三个分类区域：角色（紫色）、场景（黄绿色）、道具（青色）

**文件**：`components/AssetPanel.tsx`

### 移除创建人字段 ✅
**原因**：创建项目的用户自动成为创建者和管理员，无需手动填写

**修改**：
- 移除了CreateProjectModal中的创建人输入框
- 更新了ProjectData接口
- 清理了相关的导入和状态

**文件**：`components/CreateProjectModal.tsx`

---

## 2024年修复和改进

### 1. 查看者权限优化 ✅
**问题**：查看者看不到任何内容，整个界面被锁定遮罩覆盖

**修复**：
- 移除了ScriptEditor的全屏锁定遮罩
- 查看者现在可以：
  - 查看所有剧本内容
  - 展开/收起剧集
  - 滚动页面
  - 查看分镜表
- 查看者不能：
  - 编辑剧本内容
  - 修改状态
  - 添加新集
  - 保存更改

**文件**：`components/ScriptEditor.tsx`

### 2. 手动保存机制 ✅
**问题**：每次点击任何组件都会自动同步，造成频繁的网络请求

**修复**：
- 移除了1秒防抖的自动保存
- 添加了手动保存按钮（绿色"保存"按钮）
- 只有编辑者和管理员可以看到保存按钮
- 点击保存后才会同步到其他用户

**文件**：`components/Workspace.tsx`

**注意**：远程更新仍然是实时的，只是本地修改需要手动保存

### 3. 成员列表实时更新 ✅
**问题**：其他用户加入项目后，管理者的成员列表没有更新

**修复**：
- 在socket.js中添加了100ms延迟，确保socket完全加入房间后再广播
- 添加了日志输出，方便调试
- 确保room-users-update事件正确触发

**文件**：`server/socket.js`

### 4. 审计日志说明 ✅
**问题**：不清楚审计日志是什么

**解决**：
- 创建了详细的审计日志说明文档
- 解释了审计日志的用途和重要性
- 列出了当前记录的所有操作类型
- 提供了查询示例

**文件**：`.kiro/steering/audit-logs.md`

### 5. 状态颜色修复 ✅
**问题**：待生成状态显示为绿色，应该是灰色

**修复**：
- 将draft状态的背景色从`bg-slate-600`改为`bg-gray-500`
- 保持其他状态不变：
  - analyzing: 蓝色（闪烁）
  - analyzed/completed: 绿色

**文件**：`components/ScriptEditor.tsx`

### 6. 分镜表三点菜单 ✅
**问题**：编辑和删除功能分散，不够集中

**新增**：
- 在每个镜头卡片右上角添加三点菜单（⋮）
- 菜单包含：
  - 编辑：进入编辑模式
  - 删除：删除当前镜头（带确认）
- 鼠标悬停在镜头上时显示菜单按钮
- 点击菜单外部自动关闭

**文件**：`components/StoryboardTable.tsx`

### 7. 插入镜头优化 ✅
**问题**：需要点击编辑才能插入镜头

**修复**：
- 移除了插入镜头的编辑模式限制
- 现在鼠标悬停在两个镜头之间就会显示插入按钮
- 任何时候都可以插入新镜头（不需要先进入编辑模式）

**文件**：`components/StoryboardTable.tsx`

## 技术改进

### 防止同步循环
使用`isRemoteUpdate`标记和ref避免竞态条件，确保：
- 远程更新不会再次广播
- 本地更新才会同步到其他用户

### 手动保存的好处
- 减少网络请求
- 给用户更多控制权
- 避免编辑过程中的意外同步
- 可以批量修改后一次性保存

## 测试建议

1. **查看者权限测试**：
   - 创建一个查看者账号
   - 确认可以查看但不能编辑

2. **手动保存测试**：
   - 修改内容后不保存
   - 刷新页面，确认修改未保存
   - 点击保存按钮
   - 在另一个浏览器确认更新已同步

3. **成员列表测试**：
   - 用两个账号同时登录
   - 确认双方都能看到对方在线

4. **三点菜单测试**：
   - 鼠标悬停在镜头上
   - 点击三点菜单
   - 测试编辑和删除功能

5. **插入镜头测试**：
   - 鼠标悬停在两个镜头之间
   - 点击插入按钮
   - 确认新镜头正确插入
